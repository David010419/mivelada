<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva Premium | Mi Velada</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        /* ==========================================
           FUSIÓN DE ESTILO PREMIUM Y ESTRUCTURA GRID
           ========================================== */
        :root {
            --dorado: #c5a059;
            --mate: #121212;
            --mate-suave: #1e1e1e;
            --blanco: #ffffff;
            --borde: #333;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--mate);
            color: var(--blanco);
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }
.logo-img {
    height: 200px; /* Ajusta la altura según tu diseño */
    width: auto;  /* Mantiene la proporción */
    display: block;
    transition: transform 0.3s ease;
}

.logo-img:hover {
    transform: scale(1.05); /* Un pequeño efecto visual elegante al pasar el ratón */
}

/* Ajuste de la Navbar para alinear el logo verticalmente */
.navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 5%;
    position: absolute;
    width: 100%;
    z-index: 10;
}

/* Botones */
.btn-main {
    padding: 15px 40px;
    background-color: var(--dorado);
    color: white;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: 0.3s;
}
    
        /* --- CONTENEDOR PRINCIPAL --- */
        .booking-page { padding: 140px 5% 60px; min-height: 100vh; }
        .container-small { max-width: 800px; margin: 0 auto; }

        .playfair { 
            font-family: 'Playfair Display', serif; 
            font-size: 3rem; 
            text-align: center; 
            margin-bottom: 10px;
            color: var(--blanco);
        }
        .subtitle { text-align: center; color: #888; margin-bottom: 50px; }

        /* --- ESTRUCTURA DE FORMULARIO (GRID PARA SIMETRÍA) --- */
        .form-section { margin-bottom: 50px; }
        
        .section-label { 
            display: block; font-weight: 600; font-size: 1.1rem; 
            margin-bottom: 25px; color: var(--dorado); 
            border-bottom: 1px solid var(--borde); padding-bottom: 10px;
            text-transform: uppercase; letter-spacing: 2px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Mitad y mitad exacto */
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
        }

        .field-group { display: flex; flex-direction: column; width: 100%; }
        
        .field-label { 
            font-size: 0.75rem; 
            color: var(--dorado); 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            height: 15px; /* Altura fija para alinear los inputs */
        }

        .input-field { 
            background: var(--mate-suave);
            border: 1px solid var(--borde);
            padding: 18px;
            color: white;
            border-radius: 4px;
            font-size: 1rem;
            width: 100%;
            font-family: inherit;
            transition: 0.3s;
        }
        .input-field:focus { border-color: var(--dorado); outline: none; background: #252525; }

        /* --- TARJETAS (TURNOS Y SUPLEMENTOS) --- */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .option-card {
            background: var(--mate-suave);
            border: 1px solid var(--borde);
            padding: 35px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: 0.3s;
            position: relative;
        }

        .option-card i { font-size: 2.5rem; color: var(--dorado); margin-bottom: 15px; display: block; }
        .option-card h3 { font-size: 1rem; margin: 10px 0; color: white; text-transform: uppercase; }
        .option-card span { font-size: 0.85rem; color: #888; }
        .option-card input { position: absolute; opacity: 0; }

        /* Estados de selección */
        .option-card:has(input:checked) {
            border-color: var(--dorado);
            background: rgba(197, 160, 89, 0.08);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .option-card:has(input:disabled) {
            opacity: 0.2;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* --- RESUMEN Y BOTÓN --- */
        .summary-card { 
            background: #000; 
            padding: 40px; 
            border-radius: 8px; 
            border: 1px solid var(--dorado); 
            margin-top: 40px;
        }

        .total-line { 
            font-size: 2.2rem; 
            color: var(--dorado); 
            font-family: 'Playfair Display', serif; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-top: 1px solid #333; 
            padding-top: 25px; 
            margin-top: 20px;
        }

        .btn-submit {
            display: block; width: 100%; padding: 22px;
            background-color: var(--dorado); color: white;
            border: none; border-radius: 4px; font-weight: 700;
            font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px;
            cursor: pointer; margin-top: 30px; transition: 0.3s;
        }
        .btn-submit:hover { background-color: #b08d4a; transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }

        /* --- MÓVIL --- */
        @media (max-width: 768px) {
            .playfair { font-size: 2rem; }
            .input-grid { grid-template-columns: 1fr; gap: 15px; }
            .navbar { padding: 10px 5%; background: rgba(18,18,18,0.9); position: fixed; }
            .logo-img { height: 50px; }
            .booking-page { padding-top: 100px; }
            .option-card { padding: 20px; display: flex; align-items: center; text-align: left; gap: 20px; }
            .option-card i { margin-bottom: 0; font-size: 1.8rem; min-width: 40px; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <a href="index.html"><img src="logo.png" alt="Logo" class="logo-img"></a>
        <a href="index.html" class="btn-main">Volver al inicio</a>
    </nav>

    <main class="booking-page">
        <div class="container-small">
            <h1 class="playfair">Reserva Tu Velada</h1>
            <p class="subtitle">Vive una experiencia inolvidable rodeado de los tuyos</p>

            <form id="booking-form">
                
                <div class="form-section">
                    <label class="section-label">1. Información Personal</label>
                    <div class="input-grid">
                        <div class="field-group">
                            <span class="field-label">Nombre</span>
                            <input type="text" id="nombre" class="input-field" placeholder="Tu nombre" required>
                        </div>
                        <div class="field-group">
                            <span class="field-label">Apellidos</span>
                            <input type="text" id="apellidos" class="input-field" placeholder="Tus apellidos" required>
                        </div>
                    </div>

                    <div class="input-grid">
                        <div class="field-group">
                            <span class="field-label">Teléfono de contacto</span>
                            <input type="tel" id="telefono" class="input-field" placeholder="600 000 000" required>
                        </div>
                        <div class="field-group">
                            <span class="field-label">Fecha de nacimiento</span>
                            <input type="text" id="fechaNacimiento" class="input-field" placeholder="Día / Mes / Año" required readonly>
                        </div>
                    </div>
                    
                    <div class="field-group" style="margin-top: 20px;">
                        <span class="field-label">Correo electrónico</span>
                        <input type="email" id="email" class="input-field" placeholder="ejemplo@correo.com" required>
                    </div>
                </div>

                <div class="form-section">
                    <label class="section-label">2. Fecha del Evento</label>
                    <input type="text" id="fecha-evento" class="input-field" placeholder="Consultando disponibilidad..." required readonly>
                    <div id="price-badge" style="margin-top: 15px; display: inline-block; padding: 6px 15px; background: #333; color: var(--dorado); border-radius: 4px; font-size: 0.75rem; font-weight: 600;">Selecciona una fecha en el calendario</div>
                </div>

                <div class="form-section">
                    <label class="section-label">3. Elección de Turno</label>
                    <div class="cards-grid">
                        <label class="option-card">
                            <input type="radio" name="turno" value="Día" id="shift-day" required disabled>
                            <i class="fas fa-sun"></i>
                            <h3>Turno Día</h3>
                            <span>10:00h - 17:00h</span>
                        </label>

                        <label class="option-card">
                            <input type="radio" name="turno" value="Noche" id="shift-night" disabled>
                            <i class="fas fa-moon"></i>
                            <h3>Turno Noche</h3>
                            <span>19:00h - 02:00h <b>(+200€)</b></span>
                        </label>

                        <label class="option-card">
                            <input type="radio" name="turno" value="Día Completo" id="shift-full" disabled>
                            <i class="fas fa-clock"></i>
                            <h3>Día Completo</h3>
                            <span>10:00h - 02:00h <b>(+600€)</b></span>
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <label class="section-label">4. Servicios Adicionales</label>
                    <div class="cards-grid">
                        <label class="option-card">
                            <input type="checkbox" class="addon" data-price="150" value="Limpieza">
                            <i class="fas fa-hand-sparkles"></i>
                            <h3>Limpieza</h3>
                            <span>+150€</span>
                        </label>
                        <label class="option-card">
                            <input type="checkbox" class="addon" data-price="300" value="Sonido">
                            <i class="fas fa-music"></i>
                            <h3>Sonido Pro</h3>
                            <span>+300€</span>
                        </label>
                        <label class="option-card">
                            <input type="checkbox" class="addon" data-price="500" value="Catering">
                            <i class="fas fa-utensils"></i>
                            <h3>Catering</h3>
                            <span>Desde +500€</span>
                        </label>
                    </div>
                </div>
                <div class="coupon-section" style="margin-bottom: 20px;">
    <a href="javascript:void(0)" onclick="toggleCupon()" style="color: var(--dorado); text-decoration: none; font-size: 0.8rem; font-weight: bold;">+ ¿TIENES UN CUPÓN DE DESCUENTO?</a>
    
    <div id="cupon-input-container" style="display: none; margin-top: 15px; gap: 10px;">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="input-codigo-cupon" class="input-field" placeholder="Escribe tu código" style="padding: 10px;">
            <button type="button" onclick="validarCupon()" style="background: var(--dorado); border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">APLICAR</button>
        </div>
        <div id="cupon-mensaje" style="margin-top: 10px; font-size: 0.8rem;"></div>
    </div>
</div>

                <div class="summary-card">
                    <div style="color: #888; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; margin-bottom: 10px;">Presupuesto Estimado</div>
                    <div class="total-line">
                        <span>Total</span>
                        <span id="total-price">0€</span>
                    </div>
                    <button type="submit" id="btn-submit" class="btn-submit">Enviar Solicitud de Reserva</button>
                </div>

            </form>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <script>
        const PRECIO_DIARIO = 800, PRECIO_FINDE = 1200, PLUS_NOCHE = 200, PLUS_COMPLETO = 600;
        let precioBaseDia = 0, precioTurnoExtra = 0, precioAddons = 0, mapaDisponibilidad = {}, calendarInstance;
        let descuentoMonto = 0;
let codigoCuponValido = "";

function toggleCupon() {
    const container = document.getElementById('cupon-input-container');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
}

async function validarCupon() {
    const codigo = document.getElementById('input-codigo-cupon').value;
    const mensaje = document.getElementById('cupon-mensaje');
    
    try {
        const res = await fetch('/api/validar-cupon', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ codigo })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            descuentoMonto = data.importe;
            codigoCuponValido = codigo;
            mensaje.style.color = "#2ecc71";
            mensaje.innerText = `¡Éxito! Cupón aplicado de ${descuentoMonto}€`;
            actualizarTotal();
        } else {
            mensaje.style.color = "#e74c3c";
            mensaje.innerText = data.msg;
        }
    } catch (err) {
        console.error("Error validando cupón");
    }
}
        function initCalendar() {
            const today = new Date(); today.setHours(0,0,0,0);

            // 1. Calendario de Eventos
            calendarInstance = flatpickr("#fecha-evento", {
                minDate: "today", dateFormat: "Y-m-d", locale: "es",
                onDayCreate: (dObj, dStr, fp, dayElem) => {
                    if (dayElem.dateObj < today) return;
                    const fStr = dayElem.dateObj.getFullYear() + "-" + String(dayElem.dateObj.getMonth() + 1).padStart(2, '0') + "-" + String(dayElem.dateObj.getDate()).padStart(2, '0');
                    const turnos = mapaDisponibilidad[fStr] || [];
                    if (turnos.includes("Día Completo") || turnos.length >= 2) dayElem.classList.add("dispo-rojo");
                    else if (turnos.length === 1) dayElem.classList.add("dispo-amarillo");
                    else if (Object.keys(mapaDisponibilidad).length > 0) dayElem.classList.add("dispo-verde");
                },
                onChange: (selectedDates, dateStr) => {
                    const esFinde = (selectedDates[0].getDay() === 0 || selectedDates[0].getDay() === 5 || selectedDates[0].getDay() === 6);
                    precioBaseDia = esFinde ? PRECIO_FINDE : PRECIO_DIARIO;
                    document.getElementById('price-badge').innerText = esFinde ? "Tarifa Fin de Semana Aplicada" : "Tarifa Estándar Aplicada";
                    
                    const turnosCogidos = mapaDisponibilidad[dateStr] || [];
                    document.getElementById('shift-day').disabled = turnosCogidos.includes('Día') || turnosCogidos.includes('Día Completo');
                    document.getElementById('shift-night').disabled = turnosCogidos.includes('Noche') || turnosCogidos.includes('Día Completo');
                    document.getElementById('shift-full').disabled = turnosCogidos.length > 0;
                    actualizarTotal();
                }
            });

            // 2. Calendario Nacimiento (+21)
            const maxDateNac = new Date(); maxDateNac.setFullYear(maxDateNac.getFullYear() - 21);
            flatpickr("#fechaNacimiento", { locale: "es", dateFormat: "Y-m-d", maxDate: maxDateNac, defaultDate: maxDateNac });

            cargarDatosDisponibilidad();
        }

        async function cargarDatosDisponibilidad() {
            try {
                const res = await fetch('/api/reservas/mapa-disponibilidad');
                mapaDisponibilidad = await res.json();
                calendarInstance.redraw();
                document.getElementById('fecha-evento').placeholder = "Selecciona una fecha en el calendario";
            } catch (e) { console.error(e); }
        }

        function actualizarTotal() {
            const radioSel = document.querySelector('input[name="turno"]:checked');
            if (radioSel) {
                if (radioSel.value === 'Noche') precioTurnoExtra = PLUS_NOCHE;
                else if (radioSel.value === 'Día Completo') precioTurnoExtra = PLUS_COMPLETO;
                else precioTurnoExtra = 0;
            }
            precioAddons = 0;
            document.querySelectorAll('.addon:checked').forEach(c => precioAddons += parseInt(c.getAttribute('data-price')));
            document.getElementById('total-price').innerText = (precioBaseDia + precioTurnoExtra + precioAddons) + "€";
            const subtotal = (precioBaseDia + precioTurnoExtra + precioAddons);
    const totalFinal = subtotal - descuentoMonto;
    document.getElementById('total-price').innerText = (totalFinal < 0 ? 0 : totalFinal) + "€";
        }

        document.querySelectorAll('input[name="turno"], .addon').forEach(el => el.addEventListener('change', actualizarTotal));

        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "PROCESANDO..."; btn.disabled = true;

            const datos = {
                nombre: document.getElementById('nombre').value,
                apellidos: document.getElementById('apellidos').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                fecha: document.getElementById('fecha-evento').value,
                turno: document.querySelector('input[name="turno"]:checked').value,
                total: parseInt(document.getElementById('total-price').innerText),
                suplementos: Array.from(document.querySelectorAll('.addon:checked')).map(c => c.value),
                cupónCodigo: codigoCuponValido,
    descuentoAplicado: descuentoMonto,
    total: parseInt(document.getElementById('total-price').innerText)
            };

            try {
                const res = await fetch('/api/reservas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                if(res.ok) {
                    alert("¡Solicitud enviada correctamente! Revisa tu email.");
                    window.location.href = "index.html";
                }
            } catch (err) {
                alert("Error al enviar la solicitud.");
                btn.disabled = false; btn.innerText = "ENVIAR SOLICITUD DE RESERVA";
            }
        });

        initCalendar();
    </script>
</body>
</html>